<!doctype html><html data-enable-theme-switch="true" data-use-system-theme="false" data-default-theme="light" data-current="post" lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fixing `strncpy()` in `nconf`</title><meta name="description" content="Get to know me through my personal blogs!"><link rel="dns-prefetch" href="https://identity.netlify.com"><script async src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="/assets/css/main.css"><script>// Initialize theme
    // Must run before page rendering to prevent flash
    const themeConfig = document.documentElement.dataset;
    const theme = localStorage.getItem('theme');

    if (theme) {
      themeConfig.theme = theme;
    } else {
      const defaultTheme = themeConfig.defaultTheme;
      const useSystemTheme = themeConfig.useSystemTheme === 'true';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

      themeConfig.theme = (useSystemTheme && prefersDark) ? 'dark' : defaultTheme;
    }</script><script defer="defer" src="/assets/js/main.bundle.js"></script></head><body><div class="wrapper-bg-wrapper"><div class="wrapper-bg"></div></div><header class="site-header"><div class="site-header__container"><span class="site-header__logo-container"><a class="site-header__logo" href="/" aria-label="Logo"> <?xml version="1.0" encoding="iso-8859-1"?> <!doctype html> <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="800px" height="800px" viewBox="0 0 495.398 495.398" xml:space="preserve"><g><g><g><path d="M487.083,225.514l-75.08-75.08V63.704c0-15.682-12.708-28.391-28.413-28.391c-15.669,0-28.377,12.709-28.377,28.391
				v29.941L299.31,37.74c-27.639-27.624-75.694-27.575-103.27,0.05L8.312,225.514c-11.082,11.104-11.082,29.071,0,40.158
				c11.087,11.101,29.089,11.101,40.172,0l187.71-187.729c6.115-6.083,16.893-6.083,22.976-0.018l187.742,187.747
				c5.567,5.551,12.825,8.312,20.081,8.312c7.271,0,14.541-2.764,20.091-8.312C498.17,254.586,498.17,236.619,487.083,225.514z"/><path d="M257.561,131.836c-5.454-5.451-14.285-5.451-19.723,0L72.712,296.913c-2.607,2.606-4.085,6.164-4.085,9.877v120.401
				c0,28.253,22.908,51.16,51.16,51.16h81.754v-126.61h92.299v126.61h81.755c28.251,0,51.159-22.907,51.159-51.159V306.79
				c0-3.713-1.465-7.271-4.085-9.877L257.561,131.836z"/></g></g></g></svg> </a></span><button class="site-header__mobile-nav" data-drawer-trigger="" aria-controls="drawer-name" aria-expanded="false"><span class="site-header__mobile-nav-label">Menu</span> <svg width="226" height="187" viewBox="0 0 226 187" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 0H225.311V22.8494H0V0Z" fill="currentColor"/><path d="M0 81.872H225.311V104.721H0V81.872Z" fill="currentColor"/><path d="M0 163.744H225.311V186.593H0V163.744Z" fill="currentColor"/></svg></button><nav class="site-header__nav"><ul class="site-header__items"><li class="site-header__item"><a class="site-header__link" href="/about/">About</a></li><li class="site-header__item"><a class="site-header__link" href="/blog/">Blog</a></li><li class="site-header__item"><a class="site-header__link" href="/projects/">Projects</a></li><li class="site-header__item"><button class="site-header__link site-header__link--theme-switch" data-theme-switch><svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 14C7.01472 14 5 11.9853 5 9.5C5 7.01472 7.01472 5 9.5 5C11.9853 5 14 7.01472 14 9.5C14 11.9853 11.9853 14 9.5 14ZM9.5 13C11.433 13 13 11.433 13 9.5C13 7.567 11.433 6 9.5 6C7.567 6 6 7.567 6 9.5C6 11.433 7.567 13 9.5 13ZM10 3H9V0H10V3ZM14.4497 5.25736L13.7426 4.55025L15.864 2.42893L16.5711 3.13604L14.4497 5.25736ZM16 10V9H19V10H16ZM13.7426 14.4497L14.4497 13.7426L16.5711 15.864L15.864 16.5711L13.7426 14.4497ZM9 16H10V19H9V16ZM4.55025 13.7426L5.25736 14.4497L3.13604 16.5711L2.42893 15.864L4.55025 13.7426ZM3 9V10H0V9H3ZM5.25736 4.55025L4.55025 5.25736L2.42893 3.13604L3.13604 2.42893L5.25736 4.55025Z" fill="currentColor"/></svg></button></li></ul></nav></div></header><section class="drawer" id="drawer-name" data-drawer-target><div class="drawer__overlay" data-drawer-close tabindex="-1"></div><div class="drawer__wrapper"><div class="drawer__header"><button class="drawer__close" data-drawer-close aria-label="Close Drawer"><svg width="45" height="45" viewBox="0 0 45 45" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.84294L3.84294 0L22.4996 18.7131L41.2127 0L45 3.84294L26.3425 22.4996L45 41.2127L41.2127 45L22.4996 26.3425L3.84294 45L0 41.2127L18.7131 22.4996L0 3.84294Z" fill="currentColor"/></svg></button></div><div class="drawer__content"><ul class="drawer__nav"><li class="drawer__nav-item"><a href="/">Home</a></li><li class="drawer__nav-item"><a href="/about/">About</a></li><li class="drawer__nav-item"><a href="/blog/">Blog</a></li><li class="drawer__nav-item"><a href="/projects/">Projects</a></li></ul></div></div></section><main><div class="page-container"><article><h1>Fixing `strncpy()` in `nconf`</h1><p><time datetime="2025-07-02">July 2, 2025</time></p><hr><p>I have been putting patches right from when I was selected as a mentee in the Linux Kernel Bug Fixing Program Spring 2025. Though initially, not much of my patches received positive reviews, I wanted to keep going.</p><p>One of the areas I saw recurring discussions about was the <strong>deprecation of <code>strncpy()</code></strong> in favour of safer alternatives like <code>strscpy()</code>. That gave me the idea for my next patch = a small but meaningful change in the <strong>userspace part of the kernel</strong>: the <code>nconf</code> tool used for Kconfig configuration.</p><hr><h2 id="the-problem-with-strncpy()" tabindex="-1"><a class="header-anchor" href="#the-problem-with-strncpy()">#</a> The Problem with <code>strncpy()</code></h2><p>The <code>strncpy()</code> function in C is known for a subtle and dangerous behavior — <strong>it does not null-terminate</strong> the destination buffer if the source string is longer than the buffer size. This can result in string overflows, memory corruption or other undefined behaviour down the line.</p><p>In kernel space, the recommended replacement is <code>strscpy()</code>, a safer function that always null-terminates the destination. But in <strong>userspace</strong> (like <code>nconf</code>), <code>strscpy()</code> isn't available. That made this issue tricky.</p><hr><h2 id="finding-the-fix" tabindex="-1"><a class="header-anchor" href="#finding-the-fix">#</a> Finding the Fix</h2><p>Initially, I thought of replacing <code>strncpy()</code> with <code>snprintf()</code>, a safer standard library alternative that also handles null termination. But after some discussion with the maintainer <strong>Masahiro Yamada</strong>, he suggested a cleaner and simpler solution:</p><blockquote><p>Just <strong>keep the <code>strncpy()</code></strong> and <strong>manually ensure null termination</strong> by setting the last byte of the buffer to <code>\0</code>.</p></blockquote><p>So that’s what I did.</p><hr><h2 id="the-patch" tabindex="-1"><a class="header-anchor" href="#the-patch">#</a> The Patch</h2><p>Here’s what the final patch did:</p><ul><li>After each <code>strncpy()</code>, I explicitly null-terminated the buffer with:<pre class="language-c"><code class="language-c">buffer<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span></code></pre></li></ul><p>This ensures that no matter what the input is, the buffer remains null-terminated and safe to use.</p><p>Here’s a snippet from one of the affected locations in nconf.c:</p><pre class="language-c"><code class="language-c"><span class="token function">strncpy</span><span class="token punctuation">(</span>k_menu_items<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>str<span class="token punctuation">,</span> tmp_str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>k_menu_items<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token operator">+</span> k_menu_items<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>str<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>k_menu_items<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>str<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span></code></pre><p>And similarly, in nconf.gui.c, places like <code>fill_window()</code> and <code>dialog_inputbox()</code> were fixed the same way.</p><pre class="language-c"><code class="language-c">diff <span class="token operator">--</span>git a<span class="token operator">/</span>scripts<span class="token operator">/</span>kconfig<span class="token operator">/</span>nconf<span class="token punctuation">.</span>gui<span class="token punctuation">.</span>c b<span class="token operator">/</span>scripts<span class="token operator">/</span>kconfig<span class="token operator">/</span>nconf<span class="token punctuation">.</span>gui<span class="token punctuation">.</span>c<br>index <span class="token number">4</span>bfdf8ac2a9a34<span class="token punctuation">.</span><span class="token number">.475</span>a403ab8ba48 <span class="token number">100644</span><br><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>scripts<span class="token operator">/</span>kconfig<span class="token operator">/</span>nconf<span class="token punctuation">.</span>gui<span class="token punctuation">.</span>c<br><span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>scripts<span class="token operator">/</span>kconfig<span class="token operator">/</span>nconf<span class="token punctuation">.</span>gui<span class="token punctuation">.</span>c<br>@@ <span class="token operator">-</span><span class="token number">177</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">177</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">void</span> <span class="token function">fill_window</span><span class="token punctuation">(</span>WINDOW <span class="token operator">*</span>win<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><br> 		<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>line <span class="token operator">=</span> <span class="token function">get_line</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><br> 		<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">get_line_length</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span><br> 		<span class="token function">strncpy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token operator">-</span>		tmp<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span><br><span class="token operator">+</span>		tmp<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span><br> 		<span class="token function">mvwprintw</span><span class="token punctuation">(</span>win<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span><br> 	<span class="token punctuation">}</span><br> <span class="token punctuation">}</span><br>@@ <span class="token operator">-</span><span class="token number">359</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">359</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">int</span> <span class="token function">dialog_inputbox</span><span class="token punctuation">(</span>WINDOW <span class="token operator">*</span>main_window<span class="token punctuation">,</span><br> 	x <span class="token operator">=</span> <span class="token punctuation">(</span>columns<span class="token operator">-</span>win_cols<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><br> <br> 	<span class="token function">strncpy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> init<span class="token punctuation">,</span> <span class="token operator">*</span>result_len<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token operator">+</span>	result<span class="token punctuation">[</span><span class="token operator">*</span>result_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span><br> <br> 	<span class="token comment">/* create the windows */</span><br> 	win <span class="token operator">=</span> <span class="token function">newwin</span><span class="token punctuation">(</span>win_lines<span class="token punctuation">,</span> win_cols<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><hr><h4 id="commit-and-review-timeline" tabindex="-1"><a class="header-anchor" href="#commit-and-review-timeline">#</a> Commit and Review Timeline</h4><p>The patch was reviewed and accepted on June 27th, and later applied to the linux-kbuild tree on July 2nd, 2025. Thus, it became my second patch upstream!</p><p>It was a very smooth review process, and I really appreciated how prompt and helpful Masahiro Yamada was with feedback and suggestions.</p><ul><li><a href="https://lore.kernel.org/linux-kbuild/CAK7LNASxXXVywppjM=aqc4_TohmZnt8PHrc9HVhcZNETwONxUA@mail.gmail.com/T/#">Lore link</a></li><li><a href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/commit/?id=1b92b18ec419cac4bb57e405ac1f571e0943a950">Commit link</a></li></ul><hr><h4 id="what-i-learned" tabindex="-1"><a class="header-anchor" href="#what-i-learned">#</a> What I Learned</h4><p>This patch helped me:</p><ul><li>Understand the differences in APIs between kernel-space and user-space, like why strscpy() isn't available here.</li><li>Handle subtle C bugs involving memory safety.</li><li>Appreciate how small patches can still protect against real bugs in production tools.</li></ul><hr><h4 id="looking-ahead" tabindex="-1"><a class="header-anchor" href="#looking-ahead">#</a> Looking Ahead</h4><p>I now have a better understanding of how the kernel build system tools work internally and I’m looking forward to contributing more - possibly in areas like selftests or bpf fixes.</p><p class="tag-list"><a class="tag" href="/tags/lfx/" rel="tag">lfx</a> <a class="tag" href="/tags/linux-kernel/" rel="tag">linux-kernel</a> <a class="tag" href="/tags/kconfig/" rel="tag">kconfig</a></p></article><nav><a href="/blog/">← View All Articles</a></nav></div></main><footer class="site-footer"><small><a href="https://github.com/Shankari02" target="_blank" aria-label="GitHub"><img src="/assets/img/github.svg" alt="GitHub"> </a><a href="https://linkedin.com/in/shankari-anand" target="_blank" aria-label="LinkedIn"><img src="/assets/img/linkedin.svg" alt="LinkedIn"> </a><a href="mailto:shankari.anand618@gmail.com" target="_blank" aria-label="Twitter"><img src="/assets/img/mail.svg" alt="Email"></a></small></footer></body></html>