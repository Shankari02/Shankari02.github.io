<!doctype html><html data-enable-theme-switch="true" data-use-system-theme="false" data-default-theme="light" data-current="project" lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Over-the-air update on ESP32</title><meta name="description" content="Implementation of OTA update system on ESP32"><link rel="dns-prefetch" href="https://identity.netlify.com"><script async src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="/assets/css/main.css"><script>// Initialize theme
    // Must run before page rendering to prevent flash
    const themeConfig = document.documentElement.dataset;
    const theme = localStorage.getItem('theme');

    if (theme) {
      themeConfig.theme = theme;
    } else {
      const defaultTheme = themeConfig.defaultTheme;
      const useSystemTheme = themeConfig.useSystemTheme === 'true';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

      themeConfig.theme = (useSystemTheme && prefersDark) ? 'dark' : defaultTheme;
    }</script><script defer="defer" src="/assets/js/main.bundle.js"></script></head><body><div class="wrapper-bg-wrapper"><div class="wrapper-bg"></div></div><header class="site-header"><div class="site-header__container"><span class="site-header__logo-container"><a class="site-header__logo" href="/" aria-label="Logo"> <?xml version="1.0" encoding="iso-8859-1"?> <!doctype html> <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="800px" height="800px" viewBox="0 0 495.398 495.398" xml:space="preserve"><g><g><g><path d="M487.083,225.514l-75.08-75.08V63.704c0-15.682-12.708-28.391-28.413-28.391c-15.669,0-28.377,12.709-28.377,28.391
				v29.941L299.31,37.74c-27.639-27.624-75.694-27.575-103.27,0.05L8.312,225.514c-11.082,11.104-11.082,29.071,0,40.158
				c11.087,11.101,29.089,11.101,40.172,0l187.71-187.729c6.115-6.083,16.893-6.083,22.976-0.018l187.742,187.747
				c5.567,5.551,12.825,8.312,20.081,8.312c7.271,0,14.541-2.764,20.091-8.312C498.17,254.586,498.17,236.619,487.083,225.514z"/><path d="M257.561,131.836c-5.454-5.451-14.285-5.451-19.723,0L72.712,296.913c-2.607,2.606-4.085,6.164-4.085,9.877v120.401
				c0,28.253,22.908,51.16,51.16,51.16h81.754v-126.61h92.299v126.61h81.755c28.251,0,51.159-22.907,51.159-51.159V306.79
				c0-3.713-1.465-7.271-4.085-9.877L257.561,131.836z"/></g></g></g></svg> </a></span><button class="site-header__mobile-nav" data-drawer-trigger="" aria-controls="drawer-name" aria-expanded="false"><span class="site-header__mobile-nav-label">Menu</span> <svg width="226" height="187" viewBox="0 0 226 187" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 0H225.311V22.8494H0V0Z" fill="currentColor"/><path d="M0 81.872H225.311V104.721H0V81.872Z" fill="currentColor"/><path d="M0 163.744H225.311V186.593H0V163.744Z" fill="currentColor"/></svg></button><nav class="site-header__nav"><ul class="site-header__items"><li class="site-header__item"><a class="site-header__link" href="/about/">About</a></li><li class="site-header__item"><a class="site-header__link" href="/blog/">Blog</a></li><li class="site-header__item"><a class="site-header__link" href="/projects/">Projects</a></li><li class="site-header__item"><button class="site-header__link site-header__link--theme-switch" data-theme-switch><svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 14C7.01472 14 5 11.9853 5 9.5C5 7.01472 7.01472 5 9.5 5C11.9853 5 14 7.01472 14 9.5C14 11.9853 11.9853 14 9.5 14ZM9.5 13C11.433 13 13 11.433 13 9.5C13 7.567 11.433 6 9.5 6C7.567 6 6 7.567 6 9.5C6 11.433 7.567 13 9.5 13ZM10 3H9V0H10V3ZM14.4497 5.25736L13.7426 4.55025L15.864 2.42893L16.5711 3.13604L14.4497 5.25736ZM16 10V9H19V10H16ZM13.7426 14.4497L14.4497 13.7426L16.5711 15.864L15.864 16.5711L13.7426 14.4497ZM9 16H10V19H9V16ZM4.55025 13.7426L5.25736 14.4497L3.13604 16.5711L2.42893 15.864L4.55025 13.7426ZM3 9V10H0V9H3ZM5.25736 4.55025L4.55025 5.25736L2.42893 3.13604L3.13604 2.42893L5.25736 4.55025Z" fill="currentColor"/></svg></button></li></ul></nav></div></header><section class="drawer" id="drawer-name" data-drawer-target><div class="drawer__overlay" data-drawer-close tabindex="-1"></div><div class="drawer__wrapper"><div class="drawer__header"><button class="drawer__close" data-drawer-close aria-label="Close Drawer"><svg width="45" height="45" viewBox="0 0 45 45" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.84294L3.84294 0L22.4996 18.7131L41.2127 0L45 3.84294L26.3425 22.4996L45 41.2127L41.2127 45L22.4996 26.3425L3.84294 45L0 41.2127L18.7131 22.4996L0 3.84294Z" fill="currentColor"/></svg></button></div><div class="drawer__content"><ul class="drawer__nav"><li class="drawer__nav-item"><a href="/">Home</a></li><li class="drawer__nav-item"><a href="/about/">About</a></li><li class="drawer__nav-item"><a href="/blog/">Blog</a></li><li class="drawer__nav-item"><a href="/projects/">Projects</a></li></ul></div></div></section><main><div class="page-container"><h1><span class="project-card__emoji">üïπÔ∏è</span> Over-the-air update on ESP32</h1><hr><h3 id="project-goal" tabindex="-1"><a class="header-anchor" href="#project-goal">#</a> Project Goal</h3><p>Implement an OTA update system using ESP-IDF that allows firmware to be uploaded via a web server hosted by the ESP32 itself. The ESP32 runs in SoftAP mode and accepts firmware uploads directly through a browser. The device uses ESP-IDF's robust OTA partitioning system with rollback protection to ensure a reliable update process.</p><hr><h3 id="step-by-step-implementation" tabindex="-1"><a class="header-anchor" href="#step-by-step-implementation">#</a> Step-by-Step Implementation</h3><h4 id="partition-table-configuration" tabindex="-1"><a class="header-anchor" href="#partition-table-configuration">#</a> Partition Table Configuration</h4><p>I first enabled <strong>two OTA partitions</strong> using <code>idf.py menuconfig</code>:</p><ul><li>Go to <code>Partition Table</code> ‚Üí <code>Custom partition table CSV</code></li></ul><p>Then I created a custom partition CSV:</p><pre><code>Name, Type, SubType, Offset, Size, Flags
Note: if you have increased the bootloader size, make sure to update the offsets to  avoid overlap
nvs, data, nvs, 0xb000, 0x4000
otadata, data, ota, , 0x2000
phy_init, data, phy, , 0x1000
factory, app, factory, , 1M
ota_0, app, ota_0, , 952k
ota_1, app, ota_1, , 952K
spiffs, data, spiffs, , 512K
www, data, spiffs, , 512K
</code></pre><p>I had to carefully adjust the sizes based on the size of the firmware binary I planned to flash.</p><hr><h4 id="web-server-for-firmware-upload" tabindex="-1"><a class="header-anchor" href="#web-server-for-firmware-upload">#</a> Web Server for Firmware Upload</h4><p>I used the ESP-IDF HTTP server to build a basic file upload endpoint that receives a <code>.bin</code> file and writes it to an OTA partition.</p><p>Here‚Äôs the main logic of the upload handler:</p><pre><code>esp_err_t upload_post_handler(httpd_req_t *req) {
esp_ota_handle_t update_handle = 0 ;
const esp_partition_t *update_partition = esp_ota_get_next_update_partition(NULL);

printf(&quot;Writing to partition subtype %d at offset 0x%x\n&quot;,
       update_partition-&gt;subtype, update_partition-&gt;address);

char buf[1000] __attribute__((aligned(8)));  // ‚ö†Ô∏è Critical fix (Read ahead)
int remaining = req-&gt;content_len;
bool image_header_checked = false;

while (remaining &gt; 0) {
    int received = httpd_req_recv(req, buf, MIN(remaining, sizeof(buf)));
    if (received &lt;= 0) {
        return ESP_FAIL;
    }

    if (!image_header_checked) {
        // You can check magic byte or headers here
        image_header_checked = true;
    }

    esp_err_t err = esp_ota_write(update_handle, (const void *)buf, received);
    if (err != ESP_OK) return err;

    remaining -= received;
}

esp_ota_end(update_handle);
esp_ota_set_boot_partition(update_partition);
return ESP_OK;
}
</code></pre><hr><h4 id="testing-and-the-major-bug" tabindex="-1"><a class="header-anchor" href="#testing-and-the-major-bug">#</a> Testing and the Major Bug</h4><p>While flashing, an ip used to be hosted by the esp32 and another one as soon as the laptop is connected to the wifi hosted by the esp32. Yes, I used the SoftAP here i.e. the esp32 becomes an access point and nodes can connect to it. Once the ip's were allotted and the binary file was uploaded on the server, I ran into this cryptic error:</p><pre><code>E (42129) esp_ota_ops: OTA image has invalid magic byte (expected 0xE9, saw 0x48)
W (42129) httpd_txrx: httpd_resp_send_err: 500 Internal Server Error - Flash Error
W (42129) httpd_uri: httpd_uri: uri handler execution failed
</code></pre><p>It took me quite a while to figure out, but eventually I found the cause was <strong>buffer alignment</strong>. The flash API expects the input buffer to be 8-byte aligned.</p><p>Fix:<br><code>char buf[1000] attribute((aligned(8)));</code></p><p>Adding <code>__attribute__((aligned(8)))</code> to the buffer fixed the problem completely. From then on, uploads worked correctly.</p><hr><h4 id="configuring-softap" tabindex="-1"><a class="header-anchor" href="#configuring-softap">#</a> Configuring SoftAP</h4><p>As I said above, the ESP32 was configured to operate as a Wi-Fi Access Point (AP), so I could connect my laptop directly and open a local web page to upload the binary:</p><pre><code>wifi_config_t wifi_config = {
.ap = {
.ssid = &quot;esp32-ota&quot;,
.ssid_len = strlen(&quot;esp32-ota&quot;),
.channel = 1,
.password = &quot;esp32pass&quot;,
.max_connection = 4,
.authmode = WIFI_AUTH_WPA_WPA2_PSK
},
};
</code></pre><p>Once connected, I opened the ESP32's local IP address and uploaded a binary through a simple HTML form.</p><hr><h4 id="final-results" tabindex="-1"><a class="header-anchor" href="#final-results">#</a> Final Results</h4><ul><li><p>Successfully uploaded and flashed new firmware over Wi-Fi. Flashed LED Blink code using OTA update.<br><video width="640" height="360" controls></video></p><source src="/assets/img/blog_images/ota_project/ota-flashing.mp4" type="video/mp4">Video<p>The PCB you can see is actually known as the SRA board developed by the members of <a href="https://sravjti.in/">SRA-VJTI</a>. You can have a look <a href="https://github.com/SRA-VJTI/sra-board-hardware-design">here</a> for more information on the PCB.</p></li><li><p><a href="https://github.com/Shankari02/OTA-update-on-ESP32">Github repository</a></p></li></ul><hr><h4 id="summary" tabindex="-1"><a class="header-anchor" href="#summary">#</a> Summary</h4><p>This project taught me a lot about:</p><ul><li>ESP32's OTA update system</li><li>Writing custom partition tables</li><li>Handling web uploads in embedded systems</li><li>Debugging low-level memory alignment issues</li></ul><p>The biggest challenge was figuring out the reason for OTA failure - the misaligned buffer and learning how critical memory alignment is in embedded development.</p><hr><h4 id="primary-references" tabindex="-1"><a class="header-anchor" href="#primary-references">#</a> Primary References</h4><ul><li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ota.html">ESP-IDF OTA Update Docs</a></li><li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_http_server.html">ESP-IDF HTTP Server Docs</a></li><li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/partition-tables.html">Partition Tables</a></li></ul><nav><a href="/projects/">‚Üê View All Projects</a></nav></div></main><footer class="site-footer"><small><a href="https://github.com/Shankari02" target="_blank" aria-label="GitHub"><img src="/assets/img/github.svg" alt="GitHub"> </a><a href="https://linkedin.com/in/shankari-anand" target="_blank" aria-label="LinkedIn"><img src="/assets/img/linkedin.svg" alt="LinkedIn"> </a><a href="mailto:shankari.anand618@gmail.com" target="_blank" aria-label="Twitter"><img src="/assets/img/mail.svg" alt="Email"></a></small></footer></body></html>